<!DOCTYPE html>
<html class="no-js" lang="en-us">
<head>
    <!-- Basic Page Needs -->

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title"       content="The Weekly Challenge - Perl & Raku"/>
    <meta property="og:type"        content="website"/>
    <meta property="og:url"         content="https://perlweeklychallenge.org/"/>
    <meta property="og:image"       content="https://perlweeklychallenge.org/images/about/about.jpg"/>
    <meta property="og:description" content="You do not have to be an expert."/>
    <meta name="twitter:card"       content="summary" />
    <meta name="twitter:image"      content="https://perlweeklychallenge.org/images/about/about.jpg"/>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">

    <meta name="description" content="Advent Calendar - December 17, 2019">
    <meta name="author" content="Perl Weekly Challenge Team">
    <meta name="generator" content="Hugo 0.55.0-DEV" />

    <!-- Mobile Specific Metas -->
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Advent Calendar - December 17, 2019</title>
    <link rel="icon" href="https://perlweeklychallenge.org/images/favicon.ico">

    
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css"/>

    <!-- Twitter Bootstrs CSS -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/bootstrap/bootstrap.min.css">
    <!-- Ionicons Fonts Css -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/ionicons/ionicons.min.css">
    <!-- animate css -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/animate-css/animate.css">
    <!-- Hero area slider css-->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/slider/slider.css">
    <!-- slick slider -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/slick/slick.css">
    <!-- Fancybox -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/facncybox/jquery.fancybox.css">
    <!-- hover -->
    <link rel="stylesheet" href="https://perlweeklychallenge.org/plugins/hover/hover-min.css">
    <!-- template main css file -->
    
    <link rel="stylesheet" href="https://perlweeklychallenge.org/css/style.min.css" integrity="" media="screen">
    <link rel="stylesheet" href="https://perlweeklychallenge.org/css/main.css">
</head>

<body>

<section class="top-bar animated-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-12">
                <nav class="navbar navbar-expand-lg navbar-light bg-light">
                    <a class="navbar-brand" href="https://perlweeklychallenge.org/">
                        <img src="https://perlweeklychallenge.org/images/logo.svg" alt="logo">
                    </a>
                    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navgation" aria-controls="navigation"
                        aria-expanded="false" aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>

                    <div class="collapse navbar-collapse" id="navigation">
                        <ul class="navbar-nav ml-auto">
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/">Home</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/about">About</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/chart">Chart</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/champions">Champions</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/team">Team</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/challenges">Challenges</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/p5-reviews">Perl/Review</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/p6-reviews">Raku/Review</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/recaps">Recaps</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/blogs">Blogs</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/faq">FAQ</a>
                            </li>
                            
                            <li class="nav-item">
                                <a class="nav-link" href="https://perlweeklychallenge.org/contact">Contact</a>
                            </li>
                            
                        </ul>
                    </div>
                </nav>
            </div>
        </div>
    </div>
</section>


<section class="global-page-header">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2>Advent Calendar - December 17, 2019</h2>
                    <div class="portfolio-meta">
                        <span>Tuesday, Dec 17, 2019</span>|
                        <span> Tags:
                            Perl, Raku
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="single-post">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                
                <div style="text-align: center" class="post-img">
                    <img class="img-fluid" alt="" src="https://perlweeklychallenge.org/images/blog/2019-12-17.jpg">
                </div>
                
                <div style="text-align: justify" class="post-content">
                    

<p><a href="/blog/advent-calendar-2019"><strong>Advent Calendar 2019</strong></a></p>

<hr />

<p>The gift is presented by <a href="/blog/meet-the-champion-023"><strong>Athanasius</strong></a>. Today he is talking about his solutions to <strong>Task #2: Bitcoin Validation</strong> of <a href="/blog/perl-weekly-challenge-016"><strong>&ldquo;The Weekly Challenge - 016&rdquo;</strong></a>.</p>

<h4 id="write-a-script-to-validate-a-given-bitcoin-address-most-bitcoin-addresses-are-34-characters-they-consist-of-random-digits-and-uppercase-and-lowercase-letters-with-the-exception-that-the-uppercase-letter-o-uppercase-letter-i-lowercase-letter-l-and-the-number-0-are-never-used-to-prevent-visual-ambiguity-a-bitcoin-address-encodes-25-bytes-the-last-four-bytes-are-a-checksum-check-they-are-the-first-four-bytes-of-a-double-sha-256-digest-of-the-previous-21-bytes-for-more-information-please-refer-wiki-page-https-en-bitcoin-it-wiki-address">Write a script to validate a given bitcoin address. Most Bitcoin addresses are 34 characters. They consist of random digits and uppercase and lowercase letters, with the exception that the uppercase letter “O”, uppercase letter “I”, lowercase letter “l”, and the number “0” are never used to prevent visual ambiguity. A bitcoin address encodes 25 bytes. The last four bytes are a checksum check. They are the first four bytes of a double SHA-256 digest of the previous 21 bytes. For more information, please refer <a href="https://en.bitcoin.it/wiki/Address">wiki page</a>.</h4>

<hr />

<p>Prior to this task I knew nothing about <strong>Bitcoin</strong>; now, I still don’t know much! But I found a useful introduction, <a href="https://learnmeabitcoin.com/"><strong>Learn Me a Bitcoin</strong></a>, which explains the technology basics quite well. (But not the rationale behind the technology. I now understand what Bitcoin mining is, but not why it’s needed; and I know how the difficulty is adjusted to keep the average mining time around 10 minutes, but not why that target is important in the first place.)</p>

<p>From this <a href="https://allprivatekeys.com/bitcoin-address-format"><strong>site</strong></a> it appears that valid Bitcoin addresses can take 3 forms:</p>

<h5 id="1-pubkey-hash-p2pkh-address-with-prefix-1">1) Pubkey hash (P2PKH address) with prefix 1</h5>

<h5 id="2-script-hash-p2sh-address-with-prefix-3">2) Script hash (P2SH address) with prefix 3</h5>

<h5 id="3-segwit-mainnet-p2wpkh-address-with-prefix-bc1">3) SegWit mainnet (P2WPKH address) with prefix bc1</h5>

<p>However, for this exercise I’ve assumed that only <strong>P2PKH</strong> and <strong>P2SH</strong> addresses are included. For the record, details of <strong>P2WPKH</strong> (or <strong>Bech32</strong>) validation can be found <a href="https://github.com/bitcoin/bips/blob/master/bip-0173.mediawiki#Bech32"><strong>here</strong></a>.</p>

<h2 id="perl-solution">PERL SOLUTION</h2>

<p>CPAN’s <a href="https://metacpan.org/pod/Digest::SHA"><strong>Digest::SHA</strong></a> module has a nice OO interface and supports many SHA variants including <strong>SHA-256</strong>. For decoding <strong>Base58</strong> using the <strong>Bitcoin alphabet</strong>, module <a href="https://metacpan.org/pod/Crypt::Misc"><strong>Crypt::Misc</strong></a> has the <strong>function decode_b58b()</strong>. After that, it’s just a question of applied logic.</p>

<p>The trickiest part for me was the code to verify the checksum, which required disentangling all the different encodings. The details are given in the comments to <strong>function validate_checksum()</strong>, below:</p>

<pre><code class="language-perl">use strict;
use warnings;
use Const::Fast;
use Crypt::Misc qw( decode_b58b );
use Digest::SHA;

const my $DEFAULT_ADDR  =&gt; '1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2';
const my %ADDR_FORMATS  =&gt; (1   =&gt; 'P2PKH', 3 =&gt; 'P2SH',
                            bc1 =&gt; 'Bech32');
const my $INVALID_CHARS =&gt;  qr{([^1-9A-HJ-NP-Za-km-z])};
const my $MAX_CHARS     =&gt;  35;
const my $MIN_CHARS     =&gt;  26;
const my $SHA_ALGORITHM =&gt; 256;
const my $TAB           =&gt; '  ';

MAIN:
{
    my $address = $ARGV[0] // $DEFAULT_ADDR;

    print &quot;\nBitcoin address: \&quot;$address\&quot;\n&quot;;

    if (my $error = validate_format($address, \my $format))
    {
        print &quot;${TAB}Format validation FAILED: $error\n&quot;;
    }
    elsif ($format eq 'Bech32')
    {
        print &quot;${TAB}Bech32 format not currently supported\n&quot;;
    }
    else
    {
        print &quot;${TAB}Format is \&quot;$format\&quot;\n&quot;;

        if ($error = validate_chars($address))
        {
            print &quot;${TAB}Character validation FAILED: $error\n&quot;;
        }
        elsif (validate_checksum($address))
        {
            print &quot;${TAB}Checksum validation PASSED\n&quot;;
        }
        else
        {
            print &quot;${TAB}Checksum validation FAILED\n&quot;;
        }
    }
}

sub validate_format
{
    my ($address, $format) = @_;
    my  $error;

    for my $prefix (keys %ADDR_FORMATS)
    {
        if ($address =~ qr/^$prefix/)
        {
            $$format = $ADDR_FORMATS{$prefix};
            last;
        }
    }

    unless (defined $$format)
    {
        my $len = substr($address, 0, 1) eq 'b' ?
                  substr($address, 1, 1) eq 'c' ? 3 : 2 : 1;
        $error  = 'invalid prefix &quot;' . substr($address, 0, $len) .
                  '&quot;, unknown format';
    }

    return $error;
}

sub validate_chars
{
    my ($address) = @_;
    my  $chars    = length $address;
    my  $error;

    if    ($chars &lt; $MIN_CHARS)
    {
        $error = &quot;invalid length $chars (minimum is $MIN_CHARS)&quot;;
    }
    elsif ($chars &gt; $MAX_CHARS)
    {
        $error = &quot;invalid length $chars (maximum is $MAX_CHARS)&quot;;
    }
    elsif ($address =~ $INVALID_CHARS)
    {
        $error = &quot;invalid character \&quot;$1\&quot;&quot;;
    }

    return $error;
}

sub validate_checksum
{
    my ($address)  = @_;
    my  $rawdata   = decode_b58b($address);      # Base58 to bytes
    my  $hexdata   = unpack 'H*', $rawdata;      # Bytes  to hex
    my  $checksum1 = substr  $hexdata, -8;       # Checksum 1 in hex
    my  $payload   = substr  $hexdata,  0, -8;   # Payload in hex
    my  $sha_obj   = Digest::SHA-&gt;new($SHA_ALGORITHM);
        $sha_obj-&gt;add(pack 'H*', $payload);      # Hex to bytes
    my  $digest1   = $sha_obj-&gt;hexdigest;        # 1st digest in hex
        $sha_obj-&gt;add(pack 'H*', $digest1);      # hex to bytes
    my  $digest2   = $sha_obj-&gt;hexdigest;        # 2nd digest in hex
    my  $checksum2 = substr  $digest2,  0,  8;   # Checksum 2 in hex

    return $checksum1 eq $checksum2;             # Compare checksums
}
</code></pre>

<h2 id="raku-solution">RAKU SOLUTION</h2>

<p>I was surprised to find that pack and unpack are still considered experimental in <strong>Raku</strong>. Fortunately, the functionality I needed was available. I found <a href="https://modules.perl6.org/dist/Digest::SHA256::Native:cpan:BDUGGAN"><strong>Digest::SHA256::Native</strong></a> as a replacement for <strong>Perl</strong>’s <strong>Digest::SHA</strong>, but had to re-use the <strong>Perl</strong> module <strong>Crypt::Misc</strong> here.</p>

<p>Note: I created <strong>$decode_b58b</strong> as an alias for <strong>Crypt::Misc::decode_b58b</strong> only to keep Comma happy! This worked (it removed the error message), but I couldn’t find any way to make Comma happy with the call to pack, which is a function only and so can’t be called as a method.</p>

<p>As usual, my approach to <strong>Raku</strong> coding is to use functional-style method calls and explicity-declared variable types wherever possible. This is overkill for a script like this, but it helps me to learn. <strong>Blob[uint8]</strong> was a type I hadn’t come across before. Note also the regex:</p>

<pre><code>rx{ ( &lt;-[1..9A..HJ..NP..Za..km..z]&gt; ) }
</code></pre>

<p>which uses a negated character class <strong>(&lt;-[&hellip;]&gt;)</strong> to match any character outside the allowed Bitcoin address alphabet.</p>

<pre><code class="language-perl6">use v6;
use experimental :pack;
use Crypt::Misc:from&lt;Perl5&gt; &lt;decode_b58b&gt;;
use Digest::SHA256::Native;

my Sub $decode_b58b := &amp;Crypt::Misc::decode_b58b;

my       constant %ADDR-FORMATS  =
                  (1 =&gt; 'P2PKH', 3 =&gt; 'P2SH', bc1 =&gt; 'Bech32');
my Str   constant $DEFAULT-ADDR  =
                  '1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2';
my Regex constant $INVALID-CHARS =
                  rx{ ( &lt;-[1..9A..HJ..NP..Za..km..z]&gt; ) };
my UInt  constant $MAX-CHARS     =  35;
my UInt  constant $MIN-CHARS     =  26;
my Str   constant $TAB           = '  ';

sub MAIN(Str:D $address = $DEFAULT-ADDR)
{
    print &quot;\nBitcoin address: \&quot;$address\&quot;\n&quot;;
    my Str:D $format = '';

    if my $error = validate-format($address, $format)
    {
        print &quot;{$TAB}Format validation FAILED: $error\n&quot;;
    }
    elsif $format eq 'Bech32'
    {
        print &quot;{$TAB}Bech32 format not currently supported\n&quot;;
    }
    else
    {
        print &quot;{$TAB}Format is \&quot;$format\&quot;\n&quot;;

        if $error = validate-chars($address)
        {
            print &quot;{$TAB}Character validation FAILED: $error\n&quot;;
        }
        elsif validate-checksum($address)
        {
            print &quot;{$TAB}Checksum validation PASSED\n&quot;;
        }
        else
        {
            print &quot;{$TAB}Checksum validation FAILED\n&quot;;
        }
    }
}

sub validate-format(Str:D $address, Str:D $format is rw)
{
    my Str $error;

    for keys %ADDR-FORMATS -&gt; Str $prefix
    {
        if $address ~~ /^$prefix/
        {
            $format = %ADDR-FORMATS{$prefix};
            last;
        }
    }

    unless $format
    {
        my UInt $len = $address.substr(0, 1) eq 'b' ??
                       $address.substr(1, 1) eq 'c' ?? 3 !! 2 !! 1;

        $error = 'invalid prefix &quot;' ~ $address.substr(0, $len) ~
                 '&quot;, unknown format';
    }

    return $error;
}

sub validate-chars(Str:D $address)
{
    my $chars = $address.chars;
    my Str $error;

    if $chars &lt; $MIN-CHARS
    {
        $error = &quot;invalid length $chars (minimum is $MIN-CHARS)&quot;;
    }
    elsif $chars &gt; $MAX-CHARS
    {
        $error = &quot;invalid length $chars (maximum is $MAX-CHARS)&quot;;
    }
    elsif $address ~~ $INVALID-CHARS
    {
        $error = &quot;invalid character \&quot;$0\&quot;&quot;;
    }

    return $error;
}

sub validate-checksum(Str:D $address)
{
    my Blob[uint8] $raw-data      = $decode_b58b($address);
    my Str         $hex-data      = $raw-data.unpack('H*');
    my Str         $hex-checksum1 = $hex-data.substr(*-8);
    my Str         $hex-payload   = $hex-data.substr(0, *-8);
    my Blob[uint8] $raw-payload   = pack('H*', $hex-payload);
    my Str         $hex-digest1   = sha256-hex($raw-payload);
    my Blob[uint8] $raw_digest1   = pack('H*', $hex-digest1);
    my Str         $hex-digest2   = sha256-hex($raw_digest1);
    my Str         $hex-checksum2 = $hex-digest2.substr(0, 8);

    return $hex-checksum1 eq $hex-checksum2;
}
</code></pre>

<hr />

<p>If you have any suggestion then please do share with us <a href="mailto:perlweeklychallenge@yahoo.com">perlweeklychallenge@yahoo.com</a>.</p>

<p><a href="/blog/advent-calendar-2019"><strong>Advent Calendar 2019</strong></a></p>

                </div>
            </div>
        </div>
    </div>
</section>


<!-- Call To Action Section Start -->
<section id="call-to-action">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <div class="block">
                    <h2 class="title wow fadeInDown" data-wow-delay=".3s" data-wow-duration="500ms">SO WHAT DO YOU THINK ?</h2>
                    <p class="wow fadeInDown" data-wow-delay=".5s" data-wow-duration="500ms">If you have any suggestions or ideas then please do share with us.</p>
                    <a href="/contact" class="btn btn-default btn-contact wow fadeInDown" data-wow-delay=".7s" data-wow-duration="500ms">Contact with me</a>
                </div>
            </div>

        </div>
    </div>
</section>
<!-- Call To Action Section End -->



<!-- Footer Section Start -->
<footer id="footer">
    <div class="container">
        <div class="row content-justify-between">
            <div class="col-md-8 col-12 text-center text-lg-left text-md-left">
                <p class="copyright">Copyright:
                    <span>
                        <script>document.write(new Date().getFullYear())</script>
                    </span> PerlWeeklyChallenge. Theme Design and Developed by
                    <a href="http://www.Themefisher.com" target="_blank">Themefisher</a>.
                </p>
            </div>
            <div class="col-md-4 col-12">
                <!-- Social Media -->
                <ul class="social text-center text-md-right text-lg-right">
                    <li>
                        <a href="https://twitter.com/PerlWChallenge" class="twitter" target="_blank" title="Follow us">
                            <i class="ion-social-twitter"></i>
                        </a>
                    </li>
                    <li>
                        <a href="/rss.xml" class="rss" target="_blank" title="RSS Feed">
                            <i class="ion-social-rss"></i>
                        </a>
                    </li>
                    <li>
                        <a href="https://www.nomtimes.co.uk/site/shop.do?cref=PerlBooks" title="Free Perl Books" target="_blank">
                            <img src="/images/NomTimes.jpg" style="width:22px; height: 18px;" alt=""/>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</footer>
<!-- footer section end -->

<!-- jquery -->
<script src="https://perlweeklychallenge.org/plugins/jQurey/jquery.min.js"></script>
<!-- Form Validation -->
<script src="https://perlweeklychallenge.org/plugins/form-validation/jquery.form.js"></script>
<script src="https://perlweeklychallenge.org/plugins/form-validation/jquery.validate.min.js"></script>
<!-- slick slider -->
<script src="https://perlweeklychallenge.org/plugins/slick/slick.min.js"></script>
<!-- bootstrap js -->
<script src="https://perlweeklychallenge.org/plugins/bootstrap/bootstrap.min.js"></script>
<!-- chart js -->
<script src="https://perlweeklychallenge.org/plugins/chart/highstock.js"></script>
<script src="https://perlweeklychallenge.org/plugins/chart/drilldown.js"></script>
<script src="https://perlweeklychallenge.org/plugins/chart/data.js"></script>
<script src="https://perlweeklychallenge.org/plugins/chart/chart.js"></script>
<!-- wow js -->
<script src="https://perlweeklychallenge.org/plugins/wow-js/wow.min.js"></script>
<!-- slider js -->
<script src="https://perlweeklychallenge.org/plugins/slider/slider.js"></script>
<!-- Fancybox -->
<script src="https://perlweeklychallenge.org/plugins/facncybox/jquery.fancybox.js"></script>
<!-- template main js -->

<script src="https://perlweeklychallenge.org/js/script.min.js"></script>
<!-- google analitycs -->
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-136524905-1', 'auto');
    ga('send', 'pageview');
</script>
</body>

</html>

